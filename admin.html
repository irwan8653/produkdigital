<!DOCTYPE html>
<html lang="id" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Pengelola Produk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        display: none;
      }
      .modal.active {
        display: flex;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200">
    <div id="app" class="hidden">
      <header class="bg-gray-800 shadow-md">
        <div
          class="container mx-auto px-6 py-4 flex justify-between items-center"
        >
          <h1 class="text-2xl font-bold text-white">Dasbor Admin Produk</h1>
          <button
            id="logoutBtn"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
          >
            Logout
          </button>
        </div>
      </header>

      <main class="container mx-auto px-6 py-8">
        <div class="flex justify-end mb-6">
          <button
            id="addProductBtn"
            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg transition-colors flex items-center"
          >
            <svg
              class="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
            Tambah Produk
          </button>
        </div>

        <div class="bg-gray-800 rounded-lg shadow overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-700">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                >
                  Produk
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                >
                  Kategori
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider"
                >
                  Harga
                </th>
                <th
                  class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider"
                >
                  Aksi
                </th>
              </tr>
            </thead>
            <tbody
              id="product-table-body"
              class="divide-y divide-gray-700"
            ></tbody>
          </table>
        </div>
      </main>
    </div>

    <div
      id="productModal"
      class="modal fixed inset-0 bg-black bg-opacity-70 justify-center items-center z-50"
    >
      <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-lg shadow-2xl">
        <form id="productForm">
          <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-white">
            Tambah Produk Baru
          </h2>
          <input type="hidden" id="productId" />
          <div class="space-y-4">
            <div>
              <label
                for="nama"
                class="block text-sm font-medium text-gray-400 mb-1"
                >Nama Produk</label
              >
              <input
                type="text"
                id="nama"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                required
              />
            </div>
            <div>
              <label
                for="deskripsi"
                class="block text-sm font-medium text-gray-400 mb-1"
                >Deskripsi</label
              >
              <textarea
                id="deskripsi"
                rows="3"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                required
              ></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="harga"
                  class="block text-sm font-medium text-gray-400 mb-1"
                  >Harga (Angka saja)</label
                >
                <input
                  type="number"
                  id="harga"
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  required
                />
              </div>
              <div>
                <label
                  for="kategori"
                  class="block text-sm font-medium text-gray-400 mb-1"
                  >Kategori</label
                >
                <input
                  type="text"
                  id="kategori"
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  required
                />
              </div>
            </div>
            <div>
              <label
                for="gambar"
                class="block text-sm font-medium text-gray-400 mb-1"
                >Upload Gambar</label
              >
              <input
                type="file"
                id="gambar"
                accept="image/*"
                class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"
              />
            </div>
          </div>
          <div class="mt-8 flex justify-end space-x-4">
            <button
              type="button"
              id="cancelBtn"
              class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Batal
            </button>
            <button
              type="submit"
              id="saveBtn"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="loginModal"
      class="modal active fixed inset-0 bg-gray-900 justify-center items-center z-50"
    >
      <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
        <h2 class="text-2xl font-bold text-center mb-6 text-white">
          Login Admin
        </h2>
        <form id="loginForm" class="space-y-6">
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-400 mb-1"
              >Password</label
            >
            <input
              type="password"
              id="password"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors"
          >
            Masuk
          </button>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_BASE_URL = "https://produkdigital-production.up.railway.app";
        const API_URL = `${API_BASE_URL}/api/products`;
        const ADMIN_PASSWORD = "admin";

        const appEl = document.getElementById("app");
        const loginModal = document.getElementById("loginModal");
        const productModal = document.getElementById("productModal");
        const loginForm = document.getElementById("loginForm");
        const productForm = document.getElementById("productForm");
        const addProductBtn = document.getElementById("addProductBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const productTableBody = document.getElementById("product-table-body");
        const modalTitle = document.getElementById("modalTitle");

        const formatRupiah = (num) =>
          new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
          }).format(num);

        const fetchProducts = async () => {
          try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error("Gagal mengambil data produk");
            const products = await response.json();
            renderProducts(products);
          } catch (error) {
            console.error("Error:", error);
            alert(error.message);
          }
        };

        const renderProducts = (products) => {
          productTableBody.innerHTML = "";
          if (products.length === 0) {
            productTableBody.innerHTML =
              '<tr><td colspan="4" class="text-center py-10 text-gray-500">Belum ada produk.</td></tr>';
            return;
          }
          products.forEach((p) => {
            // Pastikan URL gambar lengkap
            const imageUrl = p.gambar
              ? `${API_BASE_URL}${p.gambar}`
              : "https://placehold.co/40x40/1f2937/ffffff?text=N/A";
            const row = `
                        <tr class="hover:bg-gray-700/50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <img class="h-10 w-10 rounded-md object-cover" src="${imageUrl}" alt="">
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-white">${
                                          p.nama
                                        }</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${
                              p.kategori
                            }</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${formatRupiah(
                              p.harga
                            )}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                                <button data-id="${
                                  p.id
                                }" class="edit-btn text-purple-400 hover:text-purple-300">Edit</button>
                                <button data-id="${
                                  p.id
                                }" class="delete-btn text-red-400 hover:text-red-300">Hapus</button>
                            </td>
                        </tr>
                    `;
            productTableBody.innerHTML += row;
          });
        };

        const openModal = (product = null) => {
          productForm.reset();
          if (product) {
            modalTitle.textContent = "Edit Produk";
            document.getElementById("productId").value = product.id;
            document.getElementById("nama").value = product.nama;
            document.getElementById("deskripsi").value = product.deskripsi;
            document.getElementById("harga").value = product.harga;
            document.getElementById("kategori").value = product.kategori;
            // Kita tidak mengisi ulang input file, hanya menampilkan gambar saat ini jika ada
          } else {
            modalTitle.textContent = "Tambah Produk Baru";
            document.getElementById("productId").value = "";
          }
          productModal.classList.add("active");
        };

        const closeModal = () => {
          productModal.classList.remove("active");
        };

        // --- FUNGSI SUBMIT FORM DIPERBARUI TOTAL ---
        const handleFormSubmit = async (e) => {
          e.preventDefault();

          // Gunakan FormData untuk mengirim file dan teks
          const formData = new FormData();
          formData.append("nama", document.getElementById("nama").value);
          formData.append(
            "deskripsi",
            document.getElementById("deskripsi").value
          );
          formData.append("harga", document.getElementById("harga").value);
          formData.append(
            "kategori",
            document.getElementById("kategori").value
          );

          const gambarInput = document.getElementById("gambar");
          // Hanya tambahkan file gambar jika dipilih
          if (gambarInput.files.length > 0) {
            formData.append("gambar", gambarInput.files[0]);
          }

          const id = document.getElementById("productId").value;
          const method = id ? "PUT" : "POST";
          const url = id ? `${API_URL}/${id}` : API_URL;

          try {
            // Saat mengirim FormData, jangan set header 'Content-Type'
            // Browser akan melakukannya secara otomatis
            const response = await fetch(url, {
              method: method,
              body: formData,
            });

            if (!response.ok) {
              const errData = await response.json();
              throw new Error(errData.message || "Gagal menyimpan produk");
            }

            closeModal();
            fetchProducts();
          } catch (error) {
            console.error("Error:", error);
            alert(error.message);
          }
        };

        const handleDelete = async (id) => {
          if (!confirm("Apakah Anda yakin ingin menghapus produk ini?")) return;

          try {
            const response = await fetch(`${API_URL}/${id}`, {
              method: "DELETE",
            });
            if (!response.ok) throw new Error("Gagal menghapus produk");
            fetchProducts();
          } catch (error) {
            console.error("Error:", error);
            alert(error.message);
          }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          const password = document.getElementById("password").value;
          if (password === ADMIN_PASSWORD) {
            sessionStorage.setItem("admin_logged_in", "true");
            loginModal.classList.remove("active");
            appEl.classList.remove("hidden");
            fetchProducts();
          } else {
            alert("Password salah!");
          }
        };

        const handleLogout = () => {
          sessionStorage.removeItem("admin_logged_in");
          loginModal.classList.add("active");
          appEl.classList.add("hidden");
        };

        // --- EVENT LISTENERS ---
        loginForm.addEventListener("submit", handleLogin);
        logoutBtn.addEventListener("click", handleLogout);
        addProductBtn.addEventListener("click", () => openModal());
        cancelBtn.addEventListener("click", closeModal);
        productForm.addEventListener("submit", handleFormSubmit);

        productTableBody.addEventListener("click", (e) => {
          if (e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            fetch(`${API_URL}/${id}`)
              .then((res) => res.json())
              .then((product) => openModal(product));
          }
          if (e.target.classList.contains("delete-btn")) {
            handleDelete(e.target.dataset.id);
          }
        });

        if (sessionStorage.getItem("admin_logged_in") === "true") {
          loginModal.classList.remove("active");
          appEl.classList.remove("hidden");
          fetchProducts();
        }
      });
    </script>
  </body>
</html>
