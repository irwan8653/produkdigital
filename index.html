<!DOCTYPE html>
<html lang="id" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-eval' https://app.midtrans.com;"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toko Digital Irwan</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script
      type="text/javascript"
      src="https://app.sandbox.midtrans.com/snap/snap.js"
      data-client-key="SB-Mid-client-4DopQX7BRxkZHWGe"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              "brand-purple": "#8A2BE2",
              "dark-bg": "#0D1117",
              "dark-card": "#161B22",
              "dark-border": "#30363D",
              "light-bg": "#f3f4f6",
              "light-card": "#FFFFFF",
              "light-border": "#E5E7EB",
            },
          },
        },
      };
    </script>

    <style>
      body {
        transition: background-color 0.3s ease, color 0.3s ease;
      }
    </style>
  </head>
  <body
    class="bg-light-bg dark:bg-dark-bg text-gray-800 dark:text-gray-200 antialiased"
  >
    <header
      class="bg-light-card/80 dark:bg-dark-card/80 backdrop-blur-lg sticky top-0 z-40"
    >
      <div class="container mx-auto px-4">
        <div class="flex items-center justify-between h-16">
          <div class="text-xl font-bold text-gray-900 dark:text-white">
            Toko<span class="text-brand-purple">Digital</span>
          </div>
          <button
            id="theme-toggle"
            type="button"
            class="text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none rounded-lg text-sm p-2.5"
          >
            <svg
              id="theme-toggle-dark-icon"
              class="hidden w-5 h-5"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
              ></path>
            </svg>
            <svg
              id="theme-toggle-light-icon"
              class="hidden w-5 h-5"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 7.072l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"
                fill-rule="evenodd"
                clip-rule="evenodd"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <div class="container mx-auto max-w-7xl px-4 py-8 md:py-12">
      <section
        class="text-center bg-light-card dark:bg-dark-card p-8 md:p-12 rounded-2xl mb-12"
      >
        <h1
          class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-4"
        >
          Koleksi Produk Digital Eksklusif
        </h1>
        <p class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400">
          Temukan e-book, template, dan video tutorial premium yang akan
          membantu meningkatkan keahlian Anda.
        </p>
      </section>

      <main
        id="productList"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"
      ></main>
    </div>

    <div
      id="purchaseModal"
      class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50"
    >
      <div
        class="bg-light-card dark:bg-dark-card rounded-2xl p-6 md:p-8 w-full max-w-md shadow-2xl transform transition-all scale-95 opacity-0"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
            Detail Pembelian
          </h2>
          <button
            id="closeModalBtn"
            class="text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white text-2xl"
          >
            &times;
          </button>
        </div>
        <div id="modalContent">
          <div class="flex items-center mb-6">
            <img
              id="modalProductImage"
              src=""
              alt="Gambar Produk"
              class="w-24 h-24 rounded-lg object-cover mr-4"
            />
            <div>
              <h3
                id="modalProductName"
                class="text-xl font-semibold mb-1 text-gray-800 dark:text-gray-100"
              >
                Nama Produk
              </h3>
              <p
                id="modalProductPrice"
                class="text-lg text-brand-purple font-medium"
              >
                Rp 0
              </p>
            </div>
          </div>
          <form id="customerForm" class="space-y-4">
            <div>
              <label
                for="customerName"
                class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >Nama Lengkap</label
              >
              <input
                type="text"
                id="customerName"
                name="customerName"
                class="w-full bg-gray-100 dark:bg-gray-700 border border-light-border dark:border-dark-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-purple focus:outline-none"
                placeholder="Masukkan nama Anda"
                required
              />
            </div>
            <div>
              <label
                for="customerEmail"
                class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1"
                >Alamat Email</label
              >
              <input
                type="email"
                id="customerEmail"
                name="customerEmail"
                class="w-full bg-gray-100 dark:bg-gray-700 border border-light-border dark:border-dark-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-brand-purple focus:outline-none"
                placeholder="contoh@email.com"
                required
              />
            </div>
            <div class="pt-4">
              <button
                type="submit"
                id="buyNowBtn"
                class="w-full bg-brand-purple hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"
              >
                <span class="btn-text">Beli Sekarang</span>
                <svg
                  class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden btn-loading"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Variabel Global
        const API_BASE_URL = "https://produkdigital-production.up.railway.app";
        const API_URL = `${API_BASE_URL}/api/products`;
        let products = []; // Array ini sekarang akan diisi dari API
        let selectedProduct = null;

        // Elemen DOM
        const productListEl = document.getElementById("productList");
        const modalEl = document.getElementById("purchaseModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const customerForm = document.getElementById("customerForm");

        // --- LOGIKA MODE GELAP/TERANG ---
        const themeToggleBtn = document.getElementById("theme-toggle");
        const themeToggleDarkIcon = document.getElementById(
          "theme-toggle-dark-icon"
        );
        const themeToggleLightIcon = document.getElementById(
          "theme-toggle-light-icon"
        );

        // Fungsi untuk mengatur tema berdasarkan preferensi
        const applyTheme = () => {
          if (
            localStorage.getItem("color-theme") === "dark" ||
            (!("color-theme" in localStorage) &&
              window.matchMedia("(prefers-color-scheme: dark)").matches)
          ) {
            document.documentElement.classList.add("dark");
            themeToggleLightIcon.classList.remove("hidden");
            themeToggleDarkIcon.classList.add("hidden");
          } else {
            document.documentElement.classList.remove("dark");
            themeToggleDarkIcon.classList.remove("hidden");
            themeToggleLightIcon.classList.add("hidden");
          }
        };

        // Event listener untuk tombol tema
        themeToggleBtn.addEventListener("click", function () {
          const isDark = document.documentElement.classList.toggle("dark");
          localStorage.setItem("color-theme", isDark ? "dark" : "light");
          applyTheme();
        });

        // --- FUNGSI-FUNGSI UTAMA ---

        const formatRupiah = (num) =>
          new Intl.NumberFormat("id-ID", {
            style: "currency",
            currency: "IDR",
            minimumFractionDigits: 0,
          }).format(num);

        // Fungsi render produk ke halaman
        function renderProducts(productsToRender) {
          productListEl.innerHTML = "";
          if (productsToRender.length === 0) {
            productListEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">Belum ada produk untuk saat ini.</p>`;
            return;
          }
          productsToRender.forEach((product) => {
            const imageUrl = product.gambar
              ? `${API_BASE_URL}${product.gambar}`
              : "https://placehold.co/400x300/161B22/ffffff?text=Produk";
            const productHtml = `
                        <div class="product-card bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-2xl overflow-hidden shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col">
                            <img src="${imageUrl}" alt="${
              product.nama
            }" class="h-48 w-full object-cover">
                            <div class="p-6 flex flex-col flex-grow">
                                <h3 class="font-bold text-xl mb-2 text-gray-900 dark:text-white">${
                                  product.nama
                                }</h3>
                                <p class="text-gray-600 dark:text-gray-400 text-sm flex-grow">${
                                  product.deskripsi
                                }</p>
                                <div class="mt-4 flex justify-between items-center">
                                    <p class="font-semibold text-xl text-brand-purple">${formatRupiah(
                                      product.harga
                                    )}</p>
                                    <button data-id="${
                                      product.id
                                    }" class="buy-button bg-brand-purple hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                        Beli
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
            productListEl.innerHTML += productHtml;
          });
        }

        // --- PERUBAHAN UTAMA: Ambil data dari API ---
        async function fetchAndRenderProducts() {
          try {
            productListEl.innerHTML = `<p class="text-center text-gray-500 col-span-full">Memuat produk...</p>`;
            const response = await fetch(API_URL);
            if (!response.ok)
              throw new Error("Gagal terhubung ke server produk.");
            products = await response.json(); // Simpan produk ke variabel global
            renderProducts(products);
          } catch (error) {
            console.error("Error fetching products:", error);
            productListEl.innerHTML = `<p class="text-center text-red-500 col-span-full">Gagal memuat produk. Coba lagi nanti.</p>`;
          }
        }

        // Logika Modal
        function openModal(product) {
          selectedProduct = product;
          const imageUrl = product.gambar
            ? `${API_BASE_URL}${product.gambar}`
            : "https://placehold.co/400x300/161B22/ffffff?text=Produk";
          document.getElementById("modalProductImage").src = imageUrl;
          document.getElementById("modalProductName").textContent =
            product.nama;
          document.getElementById("modalProductPrice").textContent =
            formatRupiah(product.harga);
          modalEl.classList.remove("hidden");
          setTimeout(() => {
            modalEl
              .querySelector(".transform")
              .classList.remove("scale-95", "opacity-0");
            modalEl
              .querySelector(".transform")
              .classList.add("scale-100", "opacity-100");
          }, 10);
        }

        function closeModal() {
          modalEl
            .querySelector(".transform")
            .classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            modalEl.classList.add("hidden");
            customerForm.reset();
          }, 300);
        }

        // Logika Pembayaran
        function processPayment(e) {
          e.preventDefault();
          const customerName = document.getElementById("customerName").value;
          const customerEmail = document.getElementById("customerEmail").value;
          if (!customerName || !customerEmail) return;

          const buyBtn = document.getElementById("buyNowBtn");
          buyBtn.querySelector(".btn-text").classList.add("hidden");
          buyBtn.querySelector(".btn-loading").classList.remove("hidden");
          buyBtn.disabled = true;

          const orderData = {
            items: [
              {
                id: selectedProduct.id,
                price: selectedProduct.harga,
                quantity: 1,
                name: selectedProduct.nama,
              },
            ],
            customerDetails: { name: customerName, email: customerEmail },
          };

          fetch(`${API_BASE_URL}/create-transaction`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData),
          })
            .then((response) => response.json())
            .then((data) => {
              buyBtn.querySelector(".btn-text").classList.remove("hidden");
              buyBtn.querySelector(".btn-loading").classList.add("hidden");
              buyBtn.disabled = false;

              if (data.token) {
                closeModal();
                window.snap.pay(data.token, {
                  onSuccess: (result) => alert("Pembayaran berhasil!"),
                  onPending: (result) => alert("Menunggu pembayaran Anda."),
                  onError: (result) => alert("Pembayaran gagal."),
                  onClose: () => alert("Anda menutup pop-up pembayaran."),
                });
              } else {
                alert(
                  "Gagal memproses pembayaran: " +
                    (data.error || "error tidak diketahui")
                );
              }
            })
            .catch((error) => {
              buyBtn.querySelector(".btn-text").classList.remove("hidden");
              buyBtn.querySelector(".btn-loading").classList.add("hidden");
              buyBtn.disabled = false;
              alert("Gagal terhubung ke server. Silakan coba lagi nanti.");
              console.error("Error:", error);
            });
        }

        // Event Listeners
        productListEl.addEventListener("click", (e) => {
          const button = e.target.closest("button.buy-button");
          if (button) {
            const productId = parseInt(button.dataset.id);
            const product = products.find((p) => p.id === productId); // Cari di data yg sudah di-fetch
            if (product) openModal(product);
          }
        });

        closeModalBtn.addEventListener("click", closeModal);
        modalEl.addEventListener("click", (e) => {
          if (e.target === modalEl) closeModal();
        });
        customerForm.addEventListener("submit", processPayment);

        // Inisialisasi Aplikasi
        applyTheme(); // Terapkan tema
        fetchAndRenderProducts(); // Ambil dan tampilkan produk dari API
      });
    </script>
  </body>
</html>
